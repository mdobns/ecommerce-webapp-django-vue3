{% extends 'base.html' %}
{% block title %}Cart | {% endblock %}
{% block content %}
<div id="cartapp" class="max-w-4xl mx-auto bg-gray-900 rounded-2xl shadow-lg p-8 text-gray-200">
    
    <!-- Page Title -->
    <h1 class="text-3xl font-bold text-white mb-6">üõí Your Cart</h1>

{% if cart %}
    
    <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-gray-800">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Product</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Quantity</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Price</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Action</th>
            </tr>
        </thead>
        
        <tbody class="bg-gray-900 divide-y divide-gray-700">
            <tr v-for="product in products" :key="product.id">
                <td class="px-6 py-4 whitespace-nowrap">[[ product.title ]]</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-600" @click="decrementQuantity(product.id, product.quantity)">-</button>
                    [[ product.quantity ]]
                    <button class="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-600" @click="incrementQuantity(product.id, product.quantity)">+</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">[[ product.total_cost ]]‡ß≥</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button @click="removeFromCart(product.id)"
                            class="px-4 py-2 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-lg shadow-md hover:scale-105 transform transition">
                        ‚ùå Remove
                    </button>
                </td>
            </tr>
            <tr>
                <td class="px-1 py-3 text-left text-xl font-bold text-white-400 uppercase tracking-wider">Total </td>
                <td class="px-6 py-3 text-left text-xl font-bold text-white-400 uppercase tracking-wider">[[totalQuantity]]</td>
                <td class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"></td>
                <td class="px-6 py-3 text-left text-xl font-bold text-white-400 uppercase tracking-wider">[[totalCost]]</td>
            </tr>
        </tbody>

    </table>
</div>
{% else %}
<p class="text-gray-400 text-lg">Your cart is empty!</p>
{% endif %}
</div>

{% endblock %}

{% block script %}
<script>
const productapp = Vue.createApp({
    delimiters: ['[[', ']]'],
    store: store,
    computed: {
    products() {
      console.log('product pass')
        return this.$data.products
    },
    totalQuantity() {
        return this.products.reduce((sum, p) => sum + p.quantity, 0);
    },
    totalCost() {
        return this.products.reduce((sum, p) => sum + p.total_cost, 0);
    }
  },
    data() {
        return {
            products: {{ products_json | safe }}
        }
    },
    methods: {
        incrementQuantity(product_id, quantity){
    const data = {
        product_id: product_id,
        update: true,
        quantity: quantity + 1
    }
    this.$store.commit('increment', 1)

    fetch('/api/add_to_cart/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        credentials: 'same-origin',
        body: JSON.stringify(data)
    })
    .then(response => {
        this.products = this.products.map(product => {
            if (product.id === product_id) {
                return { 
                    ...product, 
                    quantity: product.quantity + 1, 
                    total_cost: (product.quantity + 1) * product.price 
                };
            }
            return product;
        })
    })
    .catch(error => console.error('Error:', error))
},

decrementQuantity(product_id, quantity){
    const data = {
        product_id: product_id,
        update: true,
        quantity: quantity - 1
    }

    fetch('/api/add_to_cart/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        credentials: 'same-origin',
        body: JSON.stringify(data)
    })
    .then(response => {
        this.products = this.products.map(product => {
            if (product.id === product_id) {
                const newQuantity = product.quantity - 1;
                if (newQuantity <= 0) {
                    // remove the product from products array
                    this.$store.commit('decrement', product.quantity); // decrement by the full quantity removed
                    return null;
                }
                return { 
                    ...product, 
                    quantity: newQuantity,
                    total_cost: newQuantity * product.price
                };
            }
            return product;
        }).filter(Boolean); // remove nulls
        // if product was removed, cart count already updated above
        if (quantity === 1) {
            // already removed, nothing else needed
        } else {
            this.$store.commit('decrement', 1);
        }
    })
    .catch(error => console.error('Error:', error))
},


       removeFromCart(product_id) {
    const product = this.products.find(p => p.id === product_id)
    if (!product) return;

    var data = { 'product_id': product_id }

    fetch('/api/remove_from_cart/', {   
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'   
        },
        credentials: 'same-origin',  
        body: JSON.stringify(data)   
    })
    .then(response => {
        console.log(response)
        // Remove product from local array
        this.products = this.products.filter(p => p.id !== product_id)
        
        // Update Vuex store count
        if (this.products.length === 0) {
            this.$store.commit('setCount', 0) // set to 0 explicitly
        } else {
            this.$store.commit('decrement', product.quantity)
        }
    })
    .catch(error => {
        console.error('Error:', error)
    })
}

    }
})
productapp.use(store)
productapp.mount("#cartapp")
</script>
{% endblock %}
