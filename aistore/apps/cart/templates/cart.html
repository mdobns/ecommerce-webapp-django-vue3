{% extends 'base.html' %}
{% block title %}Cart | {% endblock %}
{% block content %}
<div id="cartapp" class="max-w-4xl mx-auto bg-gray-900 rounded-2xl shadow-lg p-8 text-gray-200">
    
    <!-- Page Title -->
    <h1 class="text-3xl font-bold text-white mb-6">üõí Your Cart</h1>

{% if cart %}
    
    <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-gray-800">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Product</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Quantity</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Price</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Action</th>
            </tr>
        </thead>
        
        <tbody class="bg-gray-900 divide-y divide-gray-700">
            <tr v-for="product in products" :key="product.id">
                <td class="px-6 py-4 whitespace-nowrap">[[ product.title ]]</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-600" @click="decrementQuantity(product.id, product.quantity)">-</button>
                    [[ product.quantity ]]
                    <button class="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-600" @click="incrementQuantity(product.id, product.quantity)">+</button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">[[ product.price * product.quantity ]]‡ß≥</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button @click="removeFromCart(product.id)"
                            class="px-4 py-2 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-lg shadow-md hover:scale-105 transform transition">
                        ‚ùå Remove
                    </button>
                </td>
            </tr>
        </tbody>

    </table>
</div>
{% else %}
<p class="text-gray-400 text-lg">Your cart is empty!</p>
{% endif %}
</div>

{% endblock %}

{% block script %}
<script>
const productapp = Vue.createApp({
    delimiters: ['[[', ']]'],
    store: store,
    computed: {
    products() {
      return this.$data.products
    }
  },
    data() {
        return {
            products: {{ products_json | safe }}
        }
    },
    methods: {
        incrementQuantity(product_id, quantity){
            console.log('product_id:', product_id)  
            var data = {
                'product_id': product_id,
                'update': true,
                'quantity': quantity+1
            }
            this.$store.commit('increment', 1)
            fetch('/api/add_to_cart/', {   
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'   
                },
                credentials: 'same-origin',  
                body: JSON.stringify(data)   
            })
            .then(response => {
                console.log(response)
                for (var i =0; i< this.products.length; i++){
                    var product= this.products[i];
                    if (product.id === product_id){
                        this.products[i].quantity +=1

                    }

                }
                 
            })
            .catch(error => {
                console.error('Error:', error)
            })

        },
        decrementQuantity(product_id, quantity){
            console.log('product_id:', product_id)  
            var data = {
                'product_id': product_id,
                'update': true,
                'quantity': quantity-1
            }
            this.$store.commit('decrement', 1)
            fetch('/api/add_to_cart/', {   
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'   
                },
                credentials: 'same-origin',  
                body: JSON.stringify(data)   
            })
            .then(response => {
                console.log(response)
                for (var i =0; i< this.products.length; i++){
                    var product= this.products[i];
                    if (product.id === product_id){
                        this.products[i].quantity -=1

                    }

                }
            })
            .catch(error => {
                console.error('Error:', error)
            })

        },
        removeFromCart(product_id) {
            console.log('product_id:', product_id)

            var data = {
                'product_id': product_id,
            }

            fetch('/api/remove_from_cart/', {   
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'   
                },
                credentials: 'same-origin',  
                body: JSON.stringify(data)   
            })
            .then(response => {
                console.log(response)
                this.products = this.products.filter(products => products.id !== product_id)
            })
            .catch(error => {
                console.error('Error:', error)
            })
        }
    }
})
productapp.use(store)
productapp.mount("#cartapp")
</script>
{% endblock %}
