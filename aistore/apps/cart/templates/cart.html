{% extends 'base.html' %}
{% block title %}Cart | {% endblock %}
{% block content %}
<div id="cartapp" class="max-w-4xl mx-auto bg-gray-900 rounded-2xl shadow-lg p-8 text-gray-200">

    <!-- Page Title -->
    <h1 class="text-3xl font-bold text-white mb-6">üõí Your Cart</h1>

    <div v-if="products.length > 0">
        <!-- Cart Table -->
        <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-800">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Product</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Quantity</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Price</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Action</th>
                </tr>
            </thead>
            <tbody class="bg-gray-900 divide-y divide-gray-700">
                <tr v-for="product in products" :key="product.id">
                    <td>
                        <img :src="product.thumbnail" class="w-14 h-14 object-cover rounded" alt="Product image">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a :href="product.url" class="text-lg font-semibold text-white hover:underline">
                        [[ product.title ]]
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-600"
                            @click="decrementQuantity(product.id, product.quantity)">-</button>
                        [[ product.quantity ]]
                        <button class="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-600"
                            @click="incrementQuantity(product.id, product.quantity)">+</button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">[[ product.total_cost ]]‡ß≥</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button @click="removeFromCart(product.id)"
                            class="px-4 py-2 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-lg shadow-md hover:scale-105 transform transition">
                            ‚ùå Remove
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Cart Summary & Coupon -->
        <div class="mt-6 p-4 bg-gray-800 rounded-lg shadow-md flex flex-col space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-lg font-bold">Total Items: [[ totalQuantity ]]</span>
                <span class="text-xl font-bold text-green-400">[[ totalCost ]]‡ß≥</span>
            </div>
            <div v-if="coupon_value > 0" class="flex justify-between items-center">
                <span class="text-lg font-bold">[[ coupon_code ]] ([[ coupon_value ]]% off)</span>
                <span class="text-xl font-bold text-green-400">Total after discount: [[ totalCostWithCupon ]]‡ß≥</span>
            </div>
            
            <div class="flex space-x-4 items-center">
                <span class="text-lg font-bold">Have a coupon?</span>
                <input type="text" v-model="coupon_code" placeholder="Enter coupon code"
                    class="px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600">
                <button @click="applyCoupon"
                    class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition">
                    Apply Coupon
                </button>
            </div>
            
            <!-- Coupon Error Message -->
            <div v-if="couponError" class="mt-2 p-2 bg-red-900/50 rounded-lg text-xs">
                <div class="flex items-center">
                    <span class="mr-2 text-red-400">‚úó</span>
                    <span class="text-red-400">[[ couponError ]]</span>
                </div>
            </div>
            
            <!-- Coupon Success Message -->
            <div v-if="coupon_value > 0 && !couponError" class="mt-2 p-2 bg-green-900/50 rounded-lg text-xs">
                <div class="flex items-center">
                    <span class="mr-2 text-green-400">‚úì</span>
                    <span class="text-green-400">Coupon applied successfully! You saved [[ coupon_value ]]%</span>
                </div>
            </div>

            {% if not user.is_authenticated %}
            <div>
                Want to order as guest or <a href="{% url 'login' %}"
              class="inline-block px-4 py-2  shadow-md hover:scale-105 transform transition">
              Login
            </a>
           /
            <a href="{% url 'signup' %}"
              class="inline-block px-4 py-2 shadow-md hover:scale-105 transform transition">
              Register
            </a>?
            </div>
            {% endif %}
        </div>

        <!-- Checkout Form -->
        <form @submit.prevent="buy" class="bg-gray-800 p-6 rounded-xl shadow-md mt-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-200 mb-1">First Name</label>
                    <input type="text" name="first_name" v-model="first_name" placeholder="Enter your first name"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                    <span v-if="fieldError('First name is required')" class="text-red-400 text-xs">[[ fieldError('First name is required') ]]</span>
                </div>
                <div>
                    <label class="block text-gray-200 mb-1">Last Name</label>
                    <input type="text" name="last_name" v-model="last_name" placeholder="Enter your last name"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                    <span v-if="fieldError('Last name is required')" class="text-red-400 text-xs">[[ fieldError('Last name is required') ]]</span>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-200 mb-1">Email</label>
                    <input type="email" name="email" v-model="email" placeholder="example@email.com"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                    <span v-if="fieldError('Email is required')" class="text-red-400 text-xs">[[ fieldError('Email is required') ]]</span>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-200 mb-1">Address</label>
                    <input type="text" name="address" v-model="address" placeholder="Street address"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                    <span v-if="fieldError('Address is required')" class="text-red-400 text-xs">[[ fieldError('Address is required') ]]</span>
                </div>
                <div>
                    <label class="block text-gray-200 mb-1">Zip Code</label>
                    <input type="number" name="zipcode" v-model="zipcode" placeholder="12345"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                    <span v-if="fieldError('Zipcode is required')" class="text-red-400 text-xs">[[ fieldError('Zipcode is required') ]]</span>
                </div>
                <div>
                    <label class="block text-gray-200 mb-1">Place</label>
                    <input type="text" name="place" v-model="place" placeholder="City / Town"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                    <span v-if="fieldError('Place is required')" class="text-red-400 text-xs">[[ fieldError('Place is required') ]]</span>
                </div>
            </div>
            <div class="flex justify-center mt-6">
                <button 
                class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition">
                Check out with Stripe
            </button>
            </div>
        </form>

    </div>
    <p class="text-gray-400 text-lg" v-else>Your cart is empty!</p>

    <!-- Error Messages -->
    <div v-if="errors.length > 0" class="space-y-3 mt-4">
        <article v-for="(error, index) in errors" :key="index"
            class="border-l-4 border-red-500 bg-red-50 rounded-lg shadow-sm p-4">
            <div class="flex items-center mb-2">
                <p class="text-red-700 font-semibold text-sm uppercase">Error</p>
            </div>
            <div class="text-red-600 text-sm">
                <p>[[ error ]]</p>
            </div>
        </article>
    </div>
</div>
{% endblock %}

{% block script %}
<script type="application/javascript" src="https://js.stripe.com/v3/"></script>
<script>
const productapp = Vue.createApp({
    delimiters: ['[[', ']]'],
    store: store,
    data() {
        return {
            errors: [],
            fieldErrors: {},
            first_name: "{{ first_name }}",
            last_name: "{{ last_name }}",
            email: "{{ email }}",
            address: '',
            zipcode: '',
            place: '',
            products: {{ products_json | safe }},
            coupon_value: 0,
            coupon_code: '',
            couponError: ''
        }
    },
    computed: {
        totalQuantity() {
            return store.state.numItems;
        },
        totalCost() {
            return this.products.reduce((sum, p) => sum + p.total_cost, 0);
        },
        totalCostWithCupon() {
            if (this.coupon_value > 0) {
                return Math.ceil(this.totalCost * (1 - this.coupon_value / 100));
            } else {
                return this.totalCost;
            }
        }
    },
    methods: {
        fieldError(msg) {
            return this.fieldErrors[msg] || '';
        },
        applyCoupon() {
            if (this.coupon_code !== '') {
                this.couponError = ''; // Clear previous errors
                fetch(`/api/can_use/?code=${encodeURIComponent(this.coupon_code)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    credentials: 'same-origin',
                })
                .then(res => res.json())
                .then(data => {
                    if (data.amount) {
                        this.coupon_value = data.amount;
                        this.couponError = '';
                    } else {
                        this.coupon_value = 0;
                        this.couponError = 'Invalid coupon code or coupon has expired';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.couponError = 'Error applying coupon. Please try again.';
                    this.coupon_value = 0;
                });
            } else {
                this.couponError = 'Please enter a coupon code';
            }
        },
        buy() {
            var data = {
                first_name: this.first_name,
                last_name: this.last_name,
                email: this.email,
                address: this.address,
                zipcode: this.zipcode,
                place: this.place,
                coupon_code: this.coupon_code
            };
            this.errors = [];
            this.fieldErrors = {};
            if (!data.first_name) this.fieldErrors['First name is required'] = 'First name is required';
            if (!data.last_name) this.fieldErrors['Last name is required'] = 'Last name is required';
            if (!data.email) this.fieldErrors['Email is required'] = 'Email is required';
            if (!data.address) this.fieldErrors['Address is required'] = 'Address is required';
            if (!data.zipcode) this.fieldErrors['Zipcode is required'] = 'Zipcode is required';
            if (!data.place) this.fieldErrors['Place is required'] = 'Place is required';

            if (Object.keys(this.fieldErrors).length === 0) {
                var stripe = Stripe('{{ pub_key }}');
                fetch("/api/create_checkout_session/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(session => stripe.redirectToCheckout({ sessionId: session.id }))
                .then(result => {
                    if (result.error) {
                        alert(result.error.message)
                    }
                })
                .catch(error => {
                    console.log('Error:', error);
                });
            }
        },
        incrementQuantity(product_id, quantity) {
            for (const product of this.products) {
                if (product.id === product_id && product.quantity < product.num_available) {
                    const data = {
                        product_id: product_id,
                        update: true,
                        quantity: quantity + 1
                    }
                    this.$store.commit('increment', 1)
                    fetch('/api/add_to_cart/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        this.products = this.products.map(p => {
                            if (p.id === product_id) {
                                return {
                                    ...p,
                                    quantity: p.quantity + 1,
                                    total_cost: (p.quantity + 1) * p.price
                                };
                            }
                            return p;
                        })
                    })
                    .catch(error => console.error('Error:', error))
                } else if (product.id === product_id) {
                    alert("No more items are available in stock.");
                    return;
                }       
            }
        },
        decrementQuantity(product_id, quantity) {
            const data = {
                product_id: product_id,
                update: true,
                quantity: quantity - 1
            }
            fetch('/api/add_to_cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => {
                this.products = this.products.map(product => {
                    if (product.id === product_id) {
                        const newQuantity = product.quantity - 1;
                        if (newQuantity <= 0) {
                            this.$store.commit('decrement', product.quantity);
                            return null;
                        }
                        return {
                            ...product,
                            quantity: newQuantity,
                            total_cost: newQuantity * product.price
                        };
                    }
                    return product;
                }).filter(Boolean);
                if (quantity !== 1) {
                    this.$store.commit('decrement', 1);
                }
            })
            .catch(error => console.error('Error:', error))
        },
        removeFromCart(product_id) {
            const product = this.products.find(p => p.id === product_id)
            if (!product) return;
            var data = { 'product_id': product_id }
            fetch('/api/remove_from_cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => {
                this.products = this.products.filter(p => p.id !== product_id)
                if (this.products.length === 0) {
                    this.$store.commit('setCount', 0)
                } else {
                    this.$store.commit('decrement', product.quantity)
                }
            })
            .catch(error => {
                console.error('Error:', error)
            })
        }
    }
})
productapp.use(store)
productapp.mount("#cartapp")
</script>
{% endblock %}