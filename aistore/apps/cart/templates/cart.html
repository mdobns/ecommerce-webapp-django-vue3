{% extends 'base.html' %}
{% block title %}Cart | {% endblock %}
{% block content %}
<div id="cartapp" class="max-w-4xl mx-auto bg-gray-900 rounded-2xl shadow-lg p-8 text-gray-200">

    <!-- Page Title -->
    <h1 class="text-3xl font-bold text-white mb-6">üõí Your Cart</h1>

    <div v-if="products.length > 0">
        <!-- Cart Table -->
        <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-800">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Product</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Quantity</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Price</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Action</th>
                </tr>
            </thead>
            <tbody class="bg-gray-900 divide-y divide-gray-700">
                <tr v-for="product in products" :key="product.id">
                    <td class="px-6 py-4 whitespace-nowrap">[[ product.title ]]</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-600"
                            @click="decrementQuantity(product.id, product.quantity)">-</button>
                        [[ product.quantity ]]
                        <button class="px-2 py-1 bg-gray-700 text-white rounded hover:bg-gray-600"
                            @click="incrementQuantity(product.id, product.quantity)">+</button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">[[ product.total_cost ]]‡ß≥</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button @click="removeFromCart(product.id)"
                            class="px-4 py-2 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-lg shadow-md hover:scale-105 transform transition">
                            ‚ùå Remove
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Cart Summary & Coupon -->
        <div class="mt-6 p-4 bg-gray-800 rounded-lg shadow-md flex flex-col space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-lg font-bold">Total Items: [[ totalQuantity ]]</span>
                <span class="text-xl font-bold text-green-400">[[ totalCost ]]‡ß≥</span>
            </div>
            <div v-if="coupon_value > 0" class="flex justify-between items-center">
                <span class="text-lg font-bold">[[ coupon_code ]] ([[ coupon_value ]]% off)</span>
                <span class="text-xl font-bold text-green-400">Total after discount: [[ totalCostWithCupon ]]‡ß≥</span>
            </div>
            
            <div class="flex space-x-4 items-center">
                <span class="text-lg font-bold">Have a coupon?</span>
                <input type="text" v-model="coupon_code" placeholder="Enter coupon code"
                    class="px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600">
                <button @click="applyCoupon"
                    class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition">
                    Apply Coupon
                </button>
            </div>
        </div>

        <!-- Checkout Form -->
        <form @submit.prevent="submitForm" class="bg-gray-800 p-6 rounded-xl shadow-md mt-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-200 mb-1">First Name</label>
                    <input type="text" name="first_name" v-model="first_name" placeholder="Enter your first name"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                </div>
                <div>
                    <label class="block text-gray-200 mb-1">Last Name</label>
                    <input type="text" name="last_name" v-model="last_name" placeholder="Enter your last name"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-200 mb-1">Email</label>
                    <input type="email" name="email" v-model="email" placeholder="example@email.com"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-200 mb-1">Address</label>
                    <input type="text" name="address" v-model="address" placeholder="Street address"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                </div>
                <div>
                    <label class="block text-gray-200 mb-1">Zip Code</label>
                    <input type="number" name="zipcode" v-model="zipcode" placeholder="12345"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                </div>
                <div>
                    <label class="block text-gray-200 mb-1">Place</label>
                    <input type="text" name="place" v-model="place" placeholder="City / Town"
                        class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" />
                </div>
            </div>
            <div class="flex justify-center mt-6">
                <button @click="buy"
                class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition">
                Check out with Stripe
            </button>
            </div>
        </form>

        <!-- Stripe Checkout Button -->
        <div class="mt-6 p-4 bg-gray-800 rounded-lg shadow-md flex justify-between items-center">
            <span class="text-lg font-bold">Total Items: [[ totalQuantity ]]</span>
            <span class="text-xl font-bold text-green-400">[[ totalCostWithCupon ]]‡ß≥</span>
            <button @click="buy"
                class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition">
                Check out with Stripe
            </button>
        </div>
    </div>
    <p class="text-gray-400 text-lg" v-else>Your cart is empty!</p>

    <!-- Error Messages -->
    <div v-if="errors.length > 0" class="space-y-3 mt-4">
        <article v-for="(error, index) in errors" :key="index"
            class="border-l-4 border-red-500 bg-red-50 rounded-lg shadow-sm p-4">
            <div class="flex items-center mb-2">
                <p class="text-red-700 font-semibold text-sm uppercase">Error</p>
            </div>
            <div class="text-red-600 text-sm">
                <p>[[ error ]]</p>
            </div>
        </article>
    </div>
</div>
{% endblock %}

{% block script %}
<script type="application/javascript" src="https://js.stripe.com/v3/"></script>
<script>
const productapp = Vue.createApp({
    delimiters: ['[[', ']]'],
    store: store,
    data() {
        return {
            errors: [],
            first_name: '',
            last_name: '',
            email: '',
            address: '',
            zipcode: '',
            place: '',
            products: {{ products_json | safe }},
            coupon_value: 0,
            coupon_code: ''
        }
    },
    computed: {
        totalQuantity() {
            return store.state.numItems;
        },
        totalCost() {
            return this.products.reduce((sum, p) => sum + p.total_cost, 0);
        },
        totalCostWithCupon() {
            if (this.coupon_value > 0) {
                return Math.ceil(this.totalCost * (1 - this.coupon_value / 100));
            } else {
                return this.totalCost;
            }
        }
    },
    methods: {
        applyCoupon() {
            if (this.coupon_code !== '') {
                fetch(`/api/can_use/?code=${encodeURIComponent(this.coupon_code)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    credentials: 'same-origin',
                })
                .then(res => res.json())
                .then(data => {
                    if (data.amount) {
                        this.coupon_value = data.amount;
                    } else {
                        this.coupon_value = 0;
                    }
                })
                .catch(error => console.error('Error:', error));
            } else {
                alert("Please enter a coupon code.");
            }
        },
        buy() {
            var data = {
                first_name: this.first_name,
                last_name: this.last_name,
                email: this.email,
                address: this.address,
                zipcode: this.zipcode,
                place: this.place,
                coupon_code: this.coupon_code
            };
            this.errors = [];
            if (!data.first_name) this.errors.push("First name is required");
            if (!data.last_name) this.errors.push("Last name is required");
            if (!data.email) this.errors.push("Email is required");
            if (!data.address) this.errors.push("Address is required");
            if (!data.zipcode) this.errors.push("Zipcode is required");
            if (!data.place) this.errors.push("Place is required");

            if (this.errors.length === 0) {
                var stripe = Stripe('{{ pub_key }}');
                fetch("/api/create_checkout_session/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(session => stripe.redirectToCheckout({ sessionId: session.id }))
                .then(result => {
                    if (result.error) {
                        alert(result.error.message)
                    }
                })
                .catch(error => {
                    console.log('Error:', error);
                });
            }
        },
        submitForm() {
            var data = {
                first_name: this.first_name,
                last_name: this.last_name,
                email: this.email,
                address: this.address,
                zipcode: this.zipcode,
                place: this.place
            };
            fetch('/api/checkout/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    window.location.href = `/order/success/${data.order_id}/`;
                } else {
                    alert("Checkout failed!");
                }
            })
            .catch(error => console.error('Error:', error));
        },
        incrementQuantity(product_id, quantity) {
            const data = {
                product_id: product_id,
                update: true,
                quantity: quantity + 1
            }
            this.$store.commit('increment', 1)
            fetch('/api/add_to_cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => {
                this.products = this.products.map(product => {
                    if (product.id === product_id) {
                        return {
                            ...product,
                            quantity: product.quantity + 1,
                            total_cost: (product.quantity + 1) * product.price
                        };
                    }
                    return product;
                })
            })
            .catch(error => console.error('Error:', error))
        },
        decrementQuantity(product_id, quantity) {
            const data = {
                product_id: product_id,
                update: true,
                quantity: quantity - 1
            }
            fetch('/api/add_to_cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => {
                this.products = this.products.map(product => {
                    if (product.id === product_id) {
                        const newQuantity = product.quantity - 1;
                        if (newQuantity <= 0) {
                            this.$store.commit('decrement', product.quantity);
                            return null;
                        }
                        return {
                            ...product,
                            quantity: newQuantity,
                            total_cost: newQuantity * product.price
                        };
                    }
                    return product;
                }).filter(Boolean);
                if (quantity !== 1) {
                    this.$store.commit('decrement', 1);
                }
            })
            .catch(error => console.error('Error:', error))
        },
        removeFromCart(product_id) {
            const product = this.products.find(p => p.id === product_id)
            if (!product) return;
            var data = { 'product_id': product_id }
            fetch('/api/remove_from_cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => {
                this.products = this.products.filter(p => p.id !== product_id)
                if (this.products.length === 0) {
                    this.$store.commit('setCount', 0)
                } else {
                    this.$store.commit('decrement', product.quantity)
                }
            })
            .catch(error => {
                console.error('Error:', error)
            })
        }
    }
})
productapp.use(store)
productapp.mount("#cartapp")
</script>
{% endblock %}