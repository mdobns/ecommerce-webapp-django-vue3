{% extends 'base.html' %}
{% block title %}{{ product.title }} | {% endblock %}
{% block content %}
<div id="productapp" class="max-w-3xl mx-auto bg-gray-900 rounded-2xl shadow-lg p-8 text-gray-200">
    
    
    <img :src="mainImage" class="w-full h-100 object-cover rounded-2xl mb-4">

    <!-- Image Thumbnails -->
    <div class="flex space-x-2 mb-4">
        <div v-for="image in images" :key="image.thumbnail">
            <img
                :src="image.thumbnail"
                @click="mainImage = image.image"
                class="w-20 h-20 object-cover rounded-lg cursor-pointer border-2 border-transparent hover:border-pink-400 transition"
                alt="Product thumbnail"
            >
        </div>
    </div>
    
    <!-- Title -->
    <h1 class="text-3xl font-bold text-white">{{ product.title }}</h1>
    
    <!-- Price -->
    <h2 class="text-xl font-semibold text-pink-400 mt-2">{{ product.price }}à§³</h2>
    
    <!-- Description -->
    {% if product.description %}
        <p class="mt-4 text-gray-300 leading-relaxed">
            {{ product.description }}
        </p>
    {% endif %}
    {% if product.variants.all|length > 0 %}
    <h3 class="text-xl font-bold text-white mb-4 mt-8">Product & Variants</h3>
    <table class="min-w-full bg-gray-800 rounded-xl overflow-hidden mb-8">
        <thead>
            <tr>
                <th class="px-4 py-2 text-left text-gray-300">Image</th>
                <th class="px-4 py-2 text-left text-gray-300">Title</th>
                <th class="px-4 py-2 text-left text-gray-300">Price</th>
                <th class="px-4 py-2 text-left text-gray-300">Stock</th>
                <th class="px-4 py-2 text-left text-gray-300">Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Main product row -->
            <tr>
                <td>
                    {% if product.thumbnail %}
                        <img src="{{ product.thumbnail.url }}" class="flex justify-center items-center h-16 rounded-lg" alt="Main product image">
                    {% endif %}
                </td>
                <td class="font-semibold text-white">{{ product.title }}</td>
                <td class="text-pink-400 font-bold ">{{ product.price }}à§³</td>
                <td class="text-xs text-gray-400 text-center">{{ product.num_available }}</td>
                <td>
                    <template v-if="cartIds.includes({{ product.id }})">
                        <a href="{% url 'cart' %}"
                           class="px-4 py-2 bg-green-600 rounded text-white font-medium inline-block transition duration-200 ease-in-out hover:scale-105">
                            âœ… Already in Cart
                        </a>
                    </template>
                    <template v-else>
                        <button @click="addToCartVariant({{ product.id }})"
                                class="px-4 py-2 bg-pink-500 rounded text-white font-medium transition duration-200 ease-in-out hover:scale-105">
                            ðŸ›’ Add to Cart
                        </button>
                    </template>
                </td>
            </tr>
            <!-- Variant rows -->
            {% for variant in product.variants.all %}
            <tr>
                <td>
                    {% if variant.thumbnail %}
                        <img src="{{ variant.thumbnail.url }}" class="flex justify-center items-center h-16 rounded-lg" alt="Variant image">
                    {% endif %}
                </td>
                <td class="font-semibold text-white">{{ variant.title }}</td>
                <td class="text-pink-400 font-bold">{{ variant.price }}à§³</td>
                <td class="text-xs text-gray-400 text-center">{{ variant.num_available }}</td>
                <td>
                    <template v-if="cartIds.includes({{ variant.id }})">
                        <a href="{% url 'cart' %}"
                           class="px-4 py-2 bg-green-600 rounded text-white font-medium inline-block transition duration-200 ease-in-out hover:scale-105">
                            âœ… Already in Cart</span>
                        </a>
                    </template>
                    <template v-else>
                        <button @click="addToCartVariant({{ variant.id }})"
                                class="px-4 py-2 bg-pink-500 rounded text-white font-medium transition duration-200 ease-in-out hover:scale-105">
                            ðŸ›’ Add to Cart
                        </button>
                    </template>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}

    <!-- Cart Button Logic (Vue controlled) -->
    <div class="flex mt-6">
        <template v-if="in_cart">
            <a href="{% url 'cart' %}"
               class="inline-block px-6 py-3 bg-gradient-to-r from-green-500 to-green-700 rounded-xl shadow-md text-white font-medium hover:scale-105 transform transition text-center">
                âœ… Already in Cart &nbsp; <span class="underline font-semibold">Go to Cart</span>
            </a>
        </template>
        <template v-else>
            {% if product.num_available > 0 %}
            <div class="flex flex-row space-x-4">
                <button @click="addToCart({{ product.id }})"
                class="px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 rounded-xl shadow-md text-white font-medium hover:scale-105 transform transition">
                ðŸ›’ Add to Cart
                </button>
                <button @click="buyNow({{ product.id }})"
                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-500 rounded-xl shadow-md text-white font-medium hover:scale-105 transform transition">
                    âš¡ Buy Now
                </button>
            </div>
            {% else %}
            <p class="mt-4 text-red-500 font-semibold">Out of Stock</p>
            {% endif %}
        </template>
    </div>
    <!-- Add to Cart Button -->
    <div class="flex flex-row space-x-4 mt-6">
{% endif %}

    <div v-if="notification" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-xl shadow-lg z-50 transition">
        [[ notification ]]
    </div>
</div>
{% endblock %}

{% block script %}
<script>
const productapp = Vue.createApp({
    delimiters: ['[[', ']]'],
    store: store,
    data() {
        return {
            notification: '' ,
            mainImage: '{{ product.image.url }}',
            images: {{ productstring|safe }},
            in_cart: {{ in_cart|yesno:"true,false" }},
            cartIds: {{ cart_items|default:"[]"|safe }},
                }
    },
    mounted() {
        console.log("Mounted")
        console.log(typeof null);
    },
    methods: {
        addToCart(product_id) {
            console.log('product_id:', product_id)

            var data = {
                'product_id': product_id,
                'update': false,
                'quantity': 1
            }

            fetch('/api/add_to_cart/', {   
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'   
                },
                credentials: 'same-origin',  
                body: JSON.stringify(data)   
            })
            .then(response => {
                this.$store.commit('increment', 1)
                this.notification = 'Product added to cart!';
                this.in_cart = true; // update immediately
                setTimeout(() => {
                    this.notification = '';
                }, 2000); // 2 seconds
            })
            .catch(error => {
                console.error('Error:', error)
            })
        },
        buyNow(product_id) {
        var data = {
            'product_id': product_id,
            'update': false,
            'quantity': 1
        };

        fetch('/api/add_to_cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
        })
        .then(response => {
            this.$store.commit('increment', 1);
            this.notification = 'Product added to cart!';
            this.in_cart = true; // update immediately
            setTimeout(() => {
                this.notification = '';
                window.location.href = '/cart/';
            }, 1200); 
        })
        .catch(error => {
            console.error('Error:', error);
        });
    },
        addToCartVariant(product_id) {
            fetch('{% url "add_to_cart_form" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `product_id=${product_id}&quantity=1`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (!this.cartIds.includes(product_id)) {
                        this.cartIds.push(product_id);
                    }
                    this.notification = 'Product added to cart!';
                    this.$store.commit('increment', 1);
                    setTimeout(() => {
                        this.notification = '';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    }
})
productapp.use(store)
productapp.mount('#productapp')
</script>
{% endblock %}
